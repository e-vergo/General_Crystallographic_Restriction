name: Deploy Blueprint
# NOTE: This workflow requires build-cache-artifacts.yml to run first to seed
# the dressed artifacts cache. Without cached artifacts, Runway has nothing to
# render and the workflow will fail at the validation step.

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: deploy-blueprint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          path: project
          fetch-depth: 0

      - name: Checkout Runway
        uses: actions/checkout@v4
        with:
          repository: e-vergo/Runway
          path: Runway
          ref: main

      - name: Checkout dress-blueprint-action (for assets)
        uses: actions/checkout@v4
        with:
          repository: e-vergo/dress-blueprint-action
          path: dress-blueprint-action
          ref: main

      - name: Restore dressed artifacts cache
        uses: actions/cache/restore@v4
        with:
          path: |
            project/.lake/build/dressed
            project/.lake/build/lib
            Runway/.lake
            Dress/.lake
          key: dress-artifacts-${{ github.sha }}
          restore-keys: |
            dress-artifacts-

      - name: Install elan
        uses: leanprover/lean-action@c544e89643240c6b398f14a431bcdc6309e36b3e # v1.4.0
        with:
          auto-config: false
          use-github-cache: false
          use-mathlib-cache: false
          build: false
          lake-package-directory: Runway

      - name: Validate dressed artifacts exist
        run: |
          if [ ! -d "project/.lake/build/dressed" ] || [ -z "$(ls -A project/.lake/build/dressed)" ]; then
            echo "ERROR: Dressed artifacts not found. Run build-cache-artifacts.yml first."
            exit 1
          fi

      - name: Generate site with Runway
        timeout-minutes: 10
        run: |
          echo "=== DEBUG: Pre-flight checks ==="
          echo "Workspace: ${{ github.workspace }}"

          echo "=== DEBUG: Checking runway-ci.json will have valid paths ==="
          echo "blueprintTexPath will be: ${{ github.workspace }}/project/blueprint/src/blueprint.tex"
          ls -la "${{ github.workspace }}/project/blueprint/src/blueprint.tex" || echo "FATAL: blueprint.tex not found!"

          echo "assetsDir will be: ${{ github.workspace }}/dress-blueprint-action/assets"
          ls -la "${{ github.workspace }}/dress-blueprint-action/assets/" || echo "FATAL: assets dir not found!"

          echo "=== DEBUG: Checking dressed artifacts ==="
          echo "manifest.json:"
          cat "${{ github.workspace }}/project/.lake/build/dressed/manifest.json" 2>/dev/null | head -50 || echo "manifest.json not found"

          echo "dep-graph.json:"
          head -20 "${{ github.workspace }}/project/.lake/build/dressed/dep-graph.json" 2>/dev/null || echo "dep-graph.json not found"

          echo "decl.tex file count:"
          find "${{ github.workspace }}/project/.lake/build/dressed" -name "decl.tex" 2>/dev/null | wc -l

          echo "=== DEBUG: Creating runway-ci.json ==="
          mkdir -p project/.lake/build/runway
          cat > project/runway-ci.json << EOF
          {
            "title": "General Crystallographic Restriction Theorem",
            "projectName": "Crystallographic",
            "githubUrl": "https://github.com/e-vergo/General_Crystallographic_Restriction",
            "baseUrl": "/General_Crystallographic_Restriction/",
            "docgen4Url": null,
            "blueprintTexPath": "${{ github.workspace }}/project/blueprint/src/blueprint.tex",
            "assetsDir": "${{ github.workspace }}/dress-blueprint-action/assets"
          }
          EOF
          cat project/runway-ci.json

          echo "=== DEBUG: Starting runway (output should show progress) ==="
          cd Runway && lake exe runway \
            --build-dir ${{ github.workspace }}/project/.lake/build \
            --output ${{ github.workspace }}/project/.lake/build/runway \
            build \
            ${{ github.workspace }}/project/runway-ci.json

          echo "=== DEBUG: Runway completed successfully ==="

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: project/.lake/build/runway

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
