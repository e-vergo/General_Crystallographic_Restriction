name: Full Build and Deploy

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.0
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: false

      # Check out GCR and sibling repos (Dress, Runway)
      - name: Checkout GCR
        uses: actions/checkout@v4
        with:
          path: GCR
          fetch-depth: 0

      - name: Checkout Dress
        uses: actions/checkout@v4
        with:
          repository: e-vergo/Dress
          path: Dress
          ref: main

      - name: Checkout Runway
        uses: actions/checkout@v4
        with:
          repository: e-vergo/Runway
          path: Runway
          ref: main

      - name: Checkout dress-blueprint-action (for assets)
        uses: actions/checkout@v4
        with:
          repository: e-vergo/dress-blueprint-action
          path: dress-blueprint-action
          ref: main

      - name: Checkout LeanArchitect
        uses: actions/checkout@v4
        with:
          repository: e-vergo/LeanArchitect
          path: LeanArchitect
          ref: main

      - name: Checkout SubVerso
        uses: actions/checkout@v4
        with:
          repository: e-vergo/subverso
          path: subverso
          ref: main

      - name: Install elan
        uses: leanprover/lean-action@c544e89643240c6b398f14a431bcdc6309e36b3e # v1.4.0
        with:
          auto-config: false
          use-github-cache: false
          use-mathlib-cache: false
          build: false
          lake-package-directory: GCR

      - name: Restore toolchain cache
        uses: actions/cache/restore@v4
        with:
          path: |
            Dress/.lake
            Runway/.lake
            LeanArchitect/.lake
            subverso/.lake
          key: toolchain-build-${{ runner.os }}-${{ hashFiles('GCR/lean-toolchain') }}
          restore-keys: |
            toolchain-build-${{ runner.os }}-

      - name: Restore mathlib cache
        id: mathlib-cache
        uses: actions/cache/restore@v4
        with:
          path: GCR/.lake/packages/mathlib
          key: mathlib-${{ runner.os }}-${{ hashFiles('GCR/lake-manifest.json') }}

      - name: Get mathlib (cache or build)
        working-directory: GCR
        run: |
          if [ "${{ steps.mathlib-cache.outputs.cache-hit }}" == "true" ]; then
            echo "Mathlib restored from GitHub Actions cache"
            find .lake/packages/mathlib -name "*.olean" 2>/dev/null | wc -l
          else
            echo "No cache hit - trying mathlib cache server..."
            lake exe cache get || echo "Server cache unavailable, will build from source"
            OLEAN_COUNT=$(find .lake/packages/mathlib -name "*.olean" 2>/dev/null | wc -l)
            echo "Found $OLEAN_COUNT oleans after cache get"
          fi

      - name: Build SubVerso
        working-directory: subverso
        run: lake build

      - name: Build LeanArchitect
        working-directory: LeanArchitect
        run: lake build

      - name: Build Dress
        working-directory: Dress
        run: lake build

      - name: Build Runway
        working-directory: Runway
        run: lake build

      - name: Build GCR with dressed artifacts
        working-directory: GCR
        run: |
          mkdir -p .lake/build
          echo "1" > .lake/build/.dress
          lake build
          rm -f .lake/build/.dress

      - name: Build blueprint facet
        working-directory: GCR
        run: lake build :blueprint

      - name: Generate dependency graph
        working-directory: GCR
        run: |
          lake env ../Dress/.lake/build/bin/extract_blueprint graph \
            --build .lake/build \
            Crystallographic

      - name: Download pre-generated DocGen4 documentation
        run: |
          # Download docs from docs-static branch (pre-generated to save CI time)
          mkdir -p GCR/.lake/build/doc
          cd GCR/.lake/build/doc
          git init
          git remote add origin https://github.com/e-vergo/General_Crystallographic_Restriction.git
          git fetch origin docs-static --depth=1
          git checkout FETCH_HEAD
          rm -rf .git
          echo "Downloaded $(find . -name '*.html' | wc -l) HTML files from docs-static branch"

      - name: Generate site with Runway
        run: |
          mkdir -p GCR/.lake/build/runway
          # Create CI-compatible runway config with absolute paths
          cat > GCR/runway-ci.json << EOF
          {
            "title": "General Crystallographic Restriction Theorem",
            "projectName": "Crystallographic",
            "githubUrl": "https://github.com/e-vergo/General_Crystallographic_Restriction",
            "baseUrl": "/General_Crystallographic_Restriction/",
            "docgen4Url": "docs/",
            "blueprintTexPath": "${{ github.workspace }}/GCR/blueprint/src/blueprint.tex",
            "assetsDir": "${{ github.workspace }}/dress-blueprint-action/assets",
            "paperTexPath": null,
            "paperTitle": "The Crystallographic Restriction Theorem: A Formalized Proof in Lean 4",
            "paperAuthors": ["J. Kuzmanovich", "A. Pavlichenkov", "E. Vergo"],
            "paperAbstract": "We present a complete formalization in Lean 4 of the crystallographic restriction theorem."
          }
          EOF
          cd Runway && lake exe runway \
            --build-dir ${{ github.workspace }}/GCR/.lake/build \
            --output ${{ github.workspace }}/GCR/.lake/build/runway \
            build \
            ${{ github.workspace }}/GCR/runway-ci.json

      - name: Copy DocGen4 to output
        run: |
          # Copy docgen4 output as 'docs' subdirectory of the site
          cp -r GCR/.lake/build/doc GCR/.lake/build/runway/docs
          echo "Copied DocGen4 docs to runway/docs/"

      - name: Save toolchain cache
        uses: actions/cache/save@v4
        with:
          path: |
            Dress/.lake
            Runway/.lake
            LeanArchitect/.lake
            subverso/.lake
          key: toolchain-build-${{ runner.os }}-${{ hashFiles('GCR/lean-toolchain') }}

      - name: Save mathlib cache
        if: steps.mathlib-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: GCR/.lake/packages/mathlib
          key: mathlib-${{ runner.os }}-${{ hashFiles('GCR/lake-manifest.json') }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: GCR/.lake/build/runway

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
