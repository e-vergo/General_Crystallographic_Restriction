name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lake packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            .lake/packages
            .lake/build
          key: lake-${{ runner.os }}-${{ hashFiles('lake-manifest.json', 'lakefile.toml') }}
          restore-keys: |
            lake-${{ runner.os }}-

      - name: Get Mathlib cache
        run: lake exe cache get

      - name: Clean Dress package and artifacts to get latest
        run: rm -rf .lake/packages/Dress .lake/packages/subverso .lake/build/dressed

      - name: Delete existing Pages artifact
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'github-pages') {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

      - name: Build blueprint with Dress
        uses: e-vergo/dress-blueprint-action@976a03f5e018f60a3cbe5702816162ad500c92fc
        with:
          build-dressed: true
          build-pdf: false
          check-decls: false
          use-mathlib-cache: false
          deploy-pages: false

      - name: Assemble site
        run: |
          mkdir -p _site
          cp docs/index.html _site/
          cp -r blueprint/web _site/blueprint

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
